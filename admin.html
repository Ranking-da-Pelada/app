<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin | Pelada 2026</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background: #070a13; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(12px); }
        .sugestao-item:hover { background: rgba(16, 185, 129, 0.2); }
        .pos-badge { background: rgba(16, 185, 129, 0.1); color: #10b981; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 900; }
        .grid-form-jogadores { display: grid; grid-template-columns: 1fr 40px 40px; gap: 5px; width: 100%; }
        .col-stats { width: 35px; text-align: center; flex-shrink: 0; }
        .player-tag { cursor: pointer; transition: all 0.2s; }
        .player-tag:hover { background: #ef4444; color: white; }
    </style>
</head>
<body class="p-4 lg:p-6">

    <div class="max-w-[1600px] mx-auto">
        <header class="mb-6 flex justify-between items-center bg-slate-900/50 p-4 rounded-2xl border border-white/5">
            <div>
                <h1 class="text-xl font-black text-emerald-500 italic uppercase leading-none">Painel Admin</h1>
                <p class="text-slate-500 text-[10px] font-bold tracking-[0.2em] uppercase mt-1">Temporada 2026</p>
            </div>
            <button onclick="resetarTudo()" class="text-[9px] bg-red-600/20 text-red-500 border border-red-500/30 px-3 py-2 rounded-xl font-bold uppercase hover:bg-red-600 hover:text-white transition">Zerar Ranking</button>
        </header>

        <div class="flex flex-col lg:grid lg:grid-cols-12 gap-6">
            <div class="order-1 lg:order-2 lg:col-span-7 space-y-6">
                <section id="secao-partida" class="glass p-5 rounded-2xl border-emerald-500/20">
                    <h2 class="text-sm font-black uppercase text-emerald-500 flex items-center gap-2 italic mb-6">
                        <i data-lucide="swords" class="w-4 h-4"></i> <span id="label-partida">Lançar Partida</span>
                    </h2>
                    <div class="space-y-4">
                        <input type="hidden" id="edit-partida-id">
                        <div class="relative">
                            <label class="font-bold text-[10px] text-slate-500 mb-1 block uppercase">Time Branco</label>
                            <input type="text" autocomplete="off" onkeyup="buscarSugestoes(this, 'sug-branco', 'tags-branco')" placeholder="Adicionar jogador..." class="w-full bg-slate-800/50 p-3 rounded-xl border border-white/10 outline-none focus:border-emerald-500 text-sm">
                            <div id="sug-branco" class="absolute z-50 w-full bg-slate-900 border border-white/20 rounded-xl hidden mt-1 shadow-2xl"></div>
                            <div id="tags-branco" class="flex flex-wrap gap-2 mt-2 min-h-[30px]"></div>
                        </div>
                        <div class="relative">
                            <label class="font-bold text-[10px] text-slate-500 mb-1 block uppercase">Time Preto</label>
                            <input type="text" autocomplete="off" onkeyup="buscarSugestoes(this, 'sug-preto', 'tags-preto')" placeholder="Adicionar jogador..." class="w-full bg-slate-800/50 p-3 rounded-xl border border-white/10 outline-none focus:border-white text-sm">
                            <div id="sug-preto" class="absolute z-50 w-full bg-slate-900 border border-white/20 rounded-xl hidden mt-1 shadow-2xl"></div>
                            <div id="tags-preto" class="flex flex-wrap gap-2 mt-2 min-h-[30px]"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <select id="modo-ponto" class="w-full bg-slate-800 p-3 rounded-xl border border-white/10 text-xs font-bold text-emerald-400 outline-none">
                                <option value="normal">NORMAL</option>
                                <option value="chuva">SÓ VITÓRIA</option>
                                <option value="amistoso">AMISTOSO</option>
                            </select>
                            <select id="vencedor" class="w-full bg-slate-800 p-3 rounded-xl border border-white/10 text-xs font-bold outline-none">
                                <option value="branco">VITÓRIA BRANCO</option>
                                <option value="preto">VITÓRIA PRETO</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-3 bg-slate-800/50 p-3 rounded-xl border border-white/10">
                            <input type="checkbox" id="penaltis" class="w-4 h-4 accent-emerald-500">
                            <label for="penaltis" class="text-[10px] font-bold text-slate-400 uppercase">Decidido nos Pênaltis</label>
                        </div>
                        <input type="date" id="data-jogo" class="w-full bg-slate-800 p-3 rounded-xl border border-white/10 text-sm outline-none">
                        <button id="btn-gravar-partida" onclick="finalizarPartida()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-4 rounded-xl font-black text-xs transition uppercase tracking-widest">Gravar Resultado</button>
                    </div>
                </section>

                <section class="glass rounded-2xl h-[450px] flex flex-col overflow-hidden">
                    <div class="p-4 bg-white/5 border-b border-white/5 text-[10px] font-bold uppercase tracking-widest text-slate-400">Histórico de Partidas</div>
                    <div id="lista-historico-partidas" class="overflow-y-auto p-4 space-y-3"></div>
                </section>

                <section class="glass p-5 rounded-2xl">
                    <h2 class="text-sm font-black uppercase text-cyan-500 mb-4 italic flex items-center gap-2">
                        <i data-lucide="users" class="w-4 h-4"></i> Gestão de Jogadores
                    </h2>
                    <div class="grid-form-jogadores mb-6">
                        <input type="hidden" id="edit-id">
                        <input type="text" id="add-nome" placeholder="Nome" class="bg-slate-800/50 px-3 py-2 rounded-lg border border-white/10 outline-none text-sm w-full">
                        <input type="text" id="add-apelido" placeholder="GT" class="bg-slate-800/50 px-1 py-2 rounded-lg border border-white/10 text-center uppercase font-bold text-[9px] w-full">
                        <button id="btn-salvar-jogador" onclick="salvarNovoJogador()" class="bg-emerald-600 rounded-lg font-bold text-[9px] uppercase w-full">OK</button>
                    </div>
                    <div id="lista-jogadores" class="space-y-2"></div>
                </section>
            </div>

            <div class="order-2 lg:order-1 lg:col-span-5">
                <section class="glass rounded-2xl overflow-hidden flex flex-col h-[600px] lg:h-auto">
                    <div class="p-4 bg-white/5 border-b border-white/5 flex justify-between items-center px-4">
                        <span class="text-[10px] font-bold uppercase tracking-widest text-yellow-500">Ranking Atual</span>
                        <div class="flex text-[9px] font-black text-slate-500 uppercase">
                            <span class="col-stats">S</span>
                            <span class="col-stats">V</span>
                            <span class="col-stats">P</span>
                        </div>
                    </div>
                    <div class="overflow-y-auto">
                        <table class="w-full">
                            <tbody id="ranking-body" class="divide-y divide-white/5"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, increment, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAN-K0QORHude3h_WQ8TrLBiA2VyuV04rY",
            authDomain: "ranking-pelada-2026.firebaseapp.com",
            projectId: "ranking-pelada-2026",
            storageBucket: "ranking-pelada-2026.firebasestorage.app",
            messagingSenderId: "893456950171",
            appId: "1:893456950171:web:a256af4e982bfc9c8a373e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let cacheJogadores = [], timeB = [], timeP = [], todasAsPartidas = [];

        async function init() {
            await carregarDados();
            lucide.createIcons();
            document.getElementById('data-jogo').valueAsDate = new Date();
        }

        async function carregarDados() {
            const snapP = await getDocs(query(collection(db, "partidas"), orderBy("timestamp", "desc")));
            todasAsPartidas = [];
            snapP.forEach(d => todasAsPartidas.push({id: d.id, ...d.data()}));

            const snapJ = await getDocs(collection(db, "jogadores"));
            const lista = document.getElementById('lista-jogadores'), ranking = document.getElementById('ranking-body');
            lista.innerHTML = ''; ranking.innerHTML = ''; cacheJogadores = [];

            snapJ.forEach(d => {
                const j = d.data();
                const jId = d.id;
                let pj = 0;
                let vRecente = 0;
                let count = 0;

                todasAsPartidas.forEach(p => {
                    const noB = p.branco.includes(jId);
                    const noP = p.preto.includes(jId);
                    if (noB || noP) {
                        pj++;
                        if (count < 5) {
                            const ganhou = (noB && p.vencedor === 'branco') || (noP && p.vencedor === 'preto');
                            if (ganhou && p.modo !== 'amistoso') vRecente += Math.pow(2, 5 - count);
                            count++;
                        }
                    }
                });

                cacheJogadores.push({
                    id: jId, ...j, 
                    totalJ: pj, 
                    saldo: j.saldo || 0, 
                    v: j.v || 0, 
                    vRecente: vRecente
                });
            });

            const jogadoresOrdenados = [...cacheJogadores].sort((a, b) => 
                (b.saldo - a.saldo) || 
                (b.v - a.v) || 
                (b.vRecente - a.vRecente) || 
                a.nome.localeCompare(b.nome)
            );

            let pos = 1;
            jogadoresOrdenados.forEach(j => {
                lista.innerHTML += `
                    <div class="p-3 rounded-xl flex items-center justify-between border border-white/5 bg-white/5">
                        <div class="flex items-center gap-3"><span class="text-[10px] font-black text-emerald-500">${j.apelido || 'GT'}</span><span class="text-xs font-bold uppercase">${j.nome}</span></div>
                        <div class="flex gap-2">
                            <button onclick="prepararEdicao('${j.id}', '${j.nome}', '${j.apelido}')" class="p-2 bg-slate-800 rounded-lg text-slate-400"><i data-lucide="edit-3" class="w-3 h-3"></i></button>
                            <button onclick="toggleVis('${j.id}', ${j.visivel})" class="p-2 bg-slate-800 rounded-lg ${j.visivel ? 'text-emerald-500' : 'text-slate-600'}"><i data-lucide="${j.visivel ? 'eye' : 'eye-off'}" class="w-3 h-3"></i></button>
                            <button onclick="excluirJogador('${j.id}')" class="p-2 bg-red-900/20 rounded-lg text-red-500"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>`;

                if(j.visivel !== false) {
                    ranking.innerHTML += `
                        <tr class="text-[11px] border-b border-white/5 h-12">
                            <td class="pl-4 w-8"><span class="pos-badge">${pos++}º</span></td>
                            <td class="px-2 font-bold uppercase text-slate-300 truncate max-w-[110px]">${j.nome}</td>
                            <td class="col-stats font-black ${j.saldo > 0 ? 'text-emerald-400' : (j.saldo < 0 ? 'text-red-400' : 'text-slate-500')}">${j.saldo}</td>
                            <td class="col-stats text-slate-400">${j.v}</td>
                            <td class="col-stats text-slate-300 font-bold">${j.totalJ}</td>
                        </tr>`;
                }
            });

            const hist = document.getElementById('lista-historico-partidas');
            hist.innerHTML = '';
            todasAsPartidas.forEach(p => {
                const nomesB = p.branco.map(id => cacheJogadores.find(j => j.id === id)?.nome || "Removido").join(", ");
                const nomesP = p.preto.map(id => cacheJogadores.find(j => j.id === id)?.nome || "Removido").join(", ");
                hist.innerHTML += `<div class="bg-white/5 p-4 rounded-xl border border-white/5 text-[10px] space-y-2">
                    <div class="flex justify-between items-center"><span class="font-black text-emerald-500 uppercase italic">Vencedor: ${p.vencedor} ${p.penaltis ? '(penaltis)' : ''}</span>
                    <div class="flex gap-2"><button onclick="excluirPartida('${p.id}')" class="text-red-500 p-1"><i data-lucide="trash-2" class="w-3 h-3"></i></button></div></div>
                    <div class="grid grid-cols-1 gap-1 border-t border-white/5 pt-2">
                    <div class="text-[9px]"><strong class="text-white/40 uppercase">B:</strong> <span class="text-slate-300">${nomesB}</span></div>
                    <div class="text-[9px]"><strong class="text-white/40 uppercase">P:</strong> <span class="text-slate-300">${nomesP}</span></div></div></div>`;
            });
            lucide.createIcons();
        }

        window.finalizarPartida = async () => {
            const data = document.getElementById('data-jogo').value;
            if(!timeB.length || !timeP.length || !data) return alert("Preencha tudo!");
            let batch = writeBatch(db);
            const vence = document.getElementById('vencedor').value, modo = document.getElementById('modo-ponto').value, penaltis = document.getElementById('penaltis').checked;
            const pRef = doc(collection(db, "partidas"));
            batch.set(pRef, { data, branco: timeB, preto: timeP, vencedor: vence, modo, penaltis, timestamp: Date.now() });
            if(modo !== 'amistoso') {
                const win = vence === 'branco' ? timeB : timeP, lose = vence === 'branco' ? timeP : timeB;
                win.forEach(id => batch.update(doc(db, "jogadores", id), { v: increment(1), saldo: increment(1) }));
                if(modo === 'normal') lose.forEach(id => batch.update(doc(db, "jogadores", id), { d: increment(1), saldo: increment(-1) }));
            }
            await batch.commit(); location.reload();
        }

        window.excluirPartida = async (id) => {
            if (confirm("Excluir esta partida e ESTORNAR os pontos dos jogadores?")) {
                const pSnap = todasAsPartidas.find(p => p.id === id);
                if (!pSnap) return;

                let batch = writeBatch(db);
                const { vencedor, modo, branco, preto } = pSnap;

                if (modo !== 'amistoso') {
                    const win = vencedor === 'branco' ? branco : preto;
                    const lose = vencedor === 'branco' ? preto : branco;

                    win.forEach(jId => batch.update(doc(db, "jogadores", jId), { v: increment(-1), saldo: increment(-1) }));
                    if (modo === 'normal') lose.forEach(jId => batch.update(doc(db, "jogadores", jId), { d: increment(-1), saldo: increment(1) }));
                }

                batch.delete(doc(db, "partidas", id));
                await batch.commit(); location.reload();
            }
        };

        window.resetarTudo = async () => { if(confirm("Zerar ranking?")) { const batch = writeBatch(db); cacheJogadores.forEach(j => batch.update(doc(db, "jogadores", j.id), { v: 0, d: 0, saldo: 0 })); todasAsPartidas.forEach(p => batch.delete(doc(db, "partidas", p.id))); await batch.commit(); location.reload(); } }
        window.removerDaLista = (id, tagsId) => { if(tagsId === 'tags-branco') timeB = timeB.filter(x => x !== id); else timeP = timeP.filter(x => x !== id); renderizarTags(); };
        function renderizarTags() {
            const bBox = document.getElementById('tags-branco'), pBox = document.getElementById('tags-preto'); bBox.innerHTML = ''; pBox.innerHTML = '';
            timeB.forEach(id => { const j = cacheJogadores.find(x => x.id === id); bBox.innerHTML += `<div onclick="removerDaLista('${id}', 'tags-branco')" class="player-tag bg-slate-800 px-2 py-1 rounded text-[10px] border border-white/5">${j?.nome}</div>`; });
            timeP.forEach(id => { const j = cacheJogadores.find(x => x.id === id); pBox.innerHTML += `<div onclick="removerDaLista('${id}', 'tags-preto')" class="player-tag bg-slate-800 px-2 py-1 rounded text-[10px] border border-white/5">${j?.nome}</div>`; });
        }
        window.buscarSugestoes = (input, sugId, tagsId) => {
            const txt = input.value.toLowerCase(), box = document.getElementById(sugId); box.innerHTML = ''; if(!txt) { box.classList.add('hidden'); return; }
            cacheJogadores.filter(j => j.nome.toLowerCase().includes(txt) && !timeB.includes(j.id) && !timeP.includes(j.id)).forEach(j => {
                const d = document.createElement('div'); d.className = "p-3 sugestao-item cursor-pointer border-b border-white/5 text-xs font-bold";
                d.textContent = j.nome; d.onclick = () => { if(tagsId === 'tags-branco') timeB.push(j.id); else timeP.push(j.id); renderizarTags(); input.value = ''; box.classList.add('hidden'); };
                box.appendChild(d);
            }); box.classList.remove('hidden');
        }
        window.salvarNovoJogador = async () => {
            const id = document.getElementById('edit-id').value, n = document.getElementById('add-nome').value, gt = document.getElementById('add-apelido').value.toUpperCase();
            if(!n || !gt) return;
            if(id) await updateDoc(doc(db, "jogadores", id), { nome: n, apelido: gt });
            else await addDoc(collection(db, "jogadores"), { nome: n, apelido: gt, v: 0, d: 0, saldo: 0, visivel: true });
            location.reload();
        }
        window.toggleVis = async (id, s) => { await updateDoc(doc(db, "jogadores", id), { visivel: !s }); location.reload(); };
        window.prepararEdicao = (id, n, a) => { document.getElementById('edit-id').value = id; document.getElementById('add-nome').value = n; document.getElementById('add-apelido').value = a; };
        window.excluirJogador = async (id) => { if(confirm("Eliminar jogador?")) { await deleteDoc(doc(db, "jogadores", id)); location.reload(); } };
        init();
    </script>
</body>
</html>
